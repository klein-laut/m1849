<!-- /templates/blog.liquid -->
{% paginate blog.articles by 4 %}

<div class="grid lookbook">

  <!-- Fixed Sidebar -->
  <aside class="grid__item large--one-eighth lookbook__list">
    <!-- <ul class="lookbook__list">
      {% for article in blog.articles %}
        <li class="lookbook__list-item">
          <a href="#{{ article.id }}">{{ article.title }}</a>
        </li>
      {% endfor %}
    </ul> -->
  </aside>
  <div class="grid__item large--three-quarters lookbook__articles">

    <!-- <header class="section-header text-center">
      <h1>
        {% if current_tags %}
          {{ blog.title | link_to: blog.url }} &mdash; {{ current_tags.first }}
        {% else %}
          {{ blog.title }}
        {% endif %}
      </h1>
    </header> -->
    {% for article in blog.articles %}

      {% assign article_content = article.excerpt_or_content %}
      {% assign featured_image_src = '' %}
      {% assign article.id = article.id %}

      {% if article.image %}
        {% assign featured_image_src = article | img_url: '1024x1024' %}
      {% elsif article_content contains '<img' %}
        {% assign featured_image_src = article_content | split: 'src="' %}
        {% assign featured_image_src = featured_image_src[1] | split: '"' | first %}
      {% endif %}

      <!-- Lookbook Article List -->
      <article class="grid" id="{{ article.id }}" data-id="{{ article.id }}">

        <div class="grid__item large--three-fifths medium--two-thirds small--one-third">
          <h3 class="lookbook__microtrend--title">
            <!-- <a href="{{ article.url }}"></a> -->
            {{ article.title }}
          </h3>

          <!-- TAGS -->
          <!-- {% if article.tags.size > 0 %}
            <ul class="tags tags--article inline-list">
              {% include 'tags-article' %}
            </ul>
          {% endif %} -->
        </div>
        <div class="grid__item large--two-fifths medium--one-third small--two-thirds">
          <div class="grid">
              <div class="grid__item one-half">
                {% if settings.social_sharing_products %}
                  {% include 'social-sharing' %}
                {% endif %}
              </div>
              <div class="grid__item one-half">
                <button type="print" name="print" class="btn">Print</button>
              </div>
          </div>
        </div>

        {% unless featured_image_src == blank %}
          <div class="grid__item">
            <div class="grid">
              <div class="grid__item">
                <img src="{{ article.image | img_url: "1024x1024" }}" alt="">
                <div class="rte rte--indented-images">
                  {{ article_content }}
                </div>
              </div>
              <div class="grid__item">
                <div class="microtrends"></div>
              </div>
            </div>
          </div>
        {% endunless %}
      </article>


      {% unless forloop.last %}<hr class="hr--clear">{% endunless %}

    {% endfor %}

    {% if paginate.pages > 1 %}
      <div class="pagination">
        {{ paginate | default_pagination | replace: '&laquo; Previous', '<span class="icon icon-arrow-left" aria-hidden="true"></span>' | replace: 'Next &raquo;', '<span class="icon icon-arrow-right" aria-hidden="true"></span>' }}
      </div>
    {% endif %}

  </div>
</div>

{% endpaginate %}

<div id="the_archives">
  {% for article in blogs[blog.handle].articles limit: 10 offset:4 %}
  <li>{{ article.title | link_to: article.url }}</li>
{% endfor %}
</div>
<script type="template/mustache" id="microtrends">
  {% raw %}
    {{#articles}}
      <div class="microtrend" data-id="{{id}}">
        <h4>Microtrend: {{title}}</h4>
        <img src="{{#img_url.large}}{{image.src}}{{/img_url.large}}" alt="">
        <div class="materials"></div>
      </div>
    {{/articles}}
  {% endraw %}
</script>
<script type="template/mustache" id="materials">
  {% raw %}
    {{#products}}
      <div class="material">
        <h4>Material: {{title}}</h4>
        <a href="/products/{{handle}}">
          <img src="{{#img_url.large}}{{image.src}}{{/img_url.large}}" alt="">
        </a>
      </div>
    {{/products}}
  {% endraw %}
</script>
<script type="text/javascript">
  Relatable.ready(function() {
    var $micro = $('#microtrends').html();
    var $material = $('#materials').html();
    
    function getMaterials(articles) {
      var ids = [];
      
      // Loop through articles and grab IDs
      for (id in articles) {
        if (articles.hasOwnProperty(id)) {
          var subArticles = articles[id].articles;
          
          for (subArticle in subArticles) {
            if (subArticles.hasOwnProperty(subArticle)) {
              ids.push(subArticles[subArticle].id);
            }
          }
        }
      }
      
      Relatable.get({
        query: "article.products",
        id: ids.join(",")
      }, function(articles) {
        for (id in articles) {
          if (articles.hasOwnProperty(id)) {
            var output = Mustache.render($material, articles[id]);
            var $html = $.parseHTML(output);
            
            $('[data-id="'+id+'"]').find('.materials').html($html);
          }
        }
      });
    }
    
    function getMicroTrends(ids) {
      // Get all micro trends
      Relatable.get({
        query: "article.articles",
        id: ids
      }, function(articles) {
        for (id in articles) {
          if (articles.hasOwnProperty(id)) {
            var output = Mustache.render($micro, articles[id]);
            var $html = $.parseHTML(output);

            $('[data-id="'+id+'"]').find('.microtrends').html($html);
          }
        }

        // Get get materials
        getMaterials(articles);
      });
    }
    
    getMicroTrends("{{ blog.articles | map: "id" | join: "," }}");
  });
</script>
